<div class="row justify-content-between">
  <div class="col-sm-9">
    <h4>{{ members && members.length }} {{ title }}</h4>
    <p>{{ subtitle }}</p>
  </div>
  <div class="col-sm-3 mb-2">
    @if (user.isAdmin && title == "Lapsed Contributing Ex-Members") {
      <button (click)="setAllToFormer()" class="btn btn-danger me-2">
        Set All To Former
      </button>
    }
    @if (user.isAdmin && title == "Former Members Not Anonymized") {
      <button (click)="anonymizeAll()" class="btn btn-danger me-2">
        Anonymize All
      </button>
    }
    <button routerLink="/reports" class="btn btn-outline-dark">
      Close &times;
    </button>
  </div>
</div>
<!-- See https://getbootstrap.com/docs/4.0/content/tables/ for explanation of class directives-->
<table class="table table-sm table-striped table-hover table-responsive">
  <caption>
    {{
      members && members.length
    }}
    members found
  </caption>
  <thead>
    <tr class="m-0">
      <!-- "scope" just tells browsers which cells the header is related to. It is not a bootstrap flex 'col' directive-->
      <th scope="col" class="w-25 d-none d-sm-table-cell">Name</th>
      <th scope="col" class="d-sm-none w-25">Details</th>
      <th scope="col" class="d-none d-sm-table-cell">Type</th>
      <th scope="col" class="d-none d-sm-table-cell">Address</th>
      <th scope="col" class="d-none d-sm-table-cell">Note</th>
      <th scope="col" class="d-none d-sm-table-cell">Payments</th>
      @if (!showDeleteDate) {
        <th scope="col" class="d-none d-sm-table-cell text-center">
          Reminder Sent
        </th>
      }
      @if (showDeleteDate) {
        <th scope="col" class="d-none d-sm-table-cell text-center">
          Delete Date
        </th>
      }
      <th scope="col" class="w-25">Actions</th>
    </tr>
  </thead>
  <tbody>
    @for (member of members; track member) {
      <tr class="m-0">
        <th scope="row" class="d-none d-sm-table-cell">
          {{ member.name }}<br />
          @if (member.businessname) {
            <span>({{ member.businessname }})</span>
          }
        </th>
        <th scope="row" class="d-sm-none">
          {{ member.name }}<br />
          @if (member.businessname) {
            <span>({{ member.businessname }})<br /></span>
          }
          <br />{{ member.count ? member.count : "No" }} payment
          @if (member.count && member.count > 1) {
            <span>s</span>
          }
          <br />
          @if (member.lasttransactiondate) {
            <span>Last paid: {{ member.lasttransactiondate }}</span>
          }
        </th>
        <td class="d-none d-sm-table-cell">
          <small>{{ member.membershiptype }}</small>
        </td>
        <td class="d-none d-sm-table-cell">
          <small
            >{{ member.addressfirstline }}<br />
            {{ member.addresssecondline }}
            @if (member.addresssecondline) {
              <br />
            }
            {{ member.postcode }}</small
          >
        </td>
        <td class="d-none d-sm-table-cell">
          <small>{{ member.note }}</small>
        </td>
        <td class="d-none d-sm-table-cell">
          <small>
            @if (member.lasttransactiondate) {
              <span>{{ member.lasttransactiondate }} <br /></span>
            }
            {{ member.count ? member.count : "No" }} payment{{
              member.count && member.count > 1 ? "s" : ""
            }}
            <br />{{ member.amount ? "Â£" + member.amount : "" }}</small
          >
        </td>
        <td class="d-none d-sm-table-cell">
          <small>
            @if (!showDeleteDate) {
              <span>{{ member.reminderdate }}</span>
            }
            @if (showDeleteDate) {
              <span>{{ member.deletedate }}</span>
            }
          </small>
        </td>
        <td>
          <button
            routerLink="/members/edit/{{ member.id }}"
            class="btn btn-sm btn-primary mr-1 mb-1"
            [disabled]="member.isUpdating"
          >
            Member Details
          </button>
          <button
            routerLink="/members/manage/{{ member.id }}"
            class="btn btn-sm btn-info mr-1 mb-1"
            [disabled]="member.isUpdating"
          >
            <span>Subscription</span>
          </button>
          <button
            routerLink="/members/transactions/{{ member.id }}"
            class="btn btn-sm btn-secondary mr-1 mb-1"
            [disabled]="member.isUpdating"
          >
            <span>Payments</span>
          </button>
          @if (showButton(ButtonName.SETTOFORMER, member)) {
            <button
              (click)="setToFormer(member)"
              class="btn btn-sm btn-warning mr-1 mb-1"
              [disabled]="member.isUpdating"
            >
              @if (member.isUpdating) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              Set to Former
            </button>
          }
          @if (showButton(ButtonName.ANONYMIZE, member)) {
            <button
              (click)="anonymize(member)"
              class="btn btn-sm btn-warning mr-1 mb-1"
              [disabled]="member.isUpdating"
            >
              @if (member.isUpdating) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              Anonymize
            </button>
          }
          @if (showButton(ButtonName.REMINDER, member)) {
            <button
              (click)="sendReminder(member)"
              class="btn btn-sm btn-success mr-1 mb-1"
              [disabled]="member.isUpdating"
            >
              @if (member.isUpdating) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              Send Reminder
            </button>
          }
          @if (showButton(ButtonName.GOCARDLESS, member)) {
            <button
              (click)="sendGoCardlessRequest(member)"
              class="btn btn-sm purple-button text-white mr-1 mb-1"
              [disabled]="member.isUpdating"
            >
              @if (member.isUpdating) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              GoCardless
            </button>
          }
          @if (showButton(ButtonName.DELETE, member)) {
            <button
              (click)="deleteMember(member)"
              class="btn btn-sm btn-danger mr-1 mb-1"
              [disabled]="member.isDeleting"
            >
              @if (member.isDeleting) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              Delete
            </button>
          }
        </td>
      </tr>
    }
    @if (!members || loading) {
      <tr>
        <td colspan="1" class="text-center">
          <span class="spinner-border spinner-border-lg align-center"></span>
        </td>
      </tr>
    }
  </tbody>
</table>
